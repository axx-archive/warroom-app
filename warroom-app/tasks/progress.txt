# Ralph Progress Log
Started: Wed Feb  4 08:01:43 PST 2026
---

## Codebase Patterns
- Use `LaneState` interface from `@/hooks/useRealtimeStatus` for lane state management (replaced useStatusPolling)
- `LanesManager` is a controlled component - pass `laneStates` prop from parent
- Polling hooks should pause when tab is hidden using visibility API
- API routes support both GET (for reading) and POST (for updating)
- Status data stored in `~/.openclaw/workspace/warroom/runs/{slug}/status.json`
- Export shared types (like `LaneUncommittedStatus`) from hooks for use in components
- Use `useRef` for popover triggers to handle click-outside detection properly
- Use `getFileWatcher(runSlug)` from `@/lib/file-watcher` to get/create watchers - singleton per run

---

## 2026-02-04 - US-101: Real-time status polling
- Implemented automatic 5-second polling of lane statuses
- Files changed:
  - `src/app/api/runs/[slug]/status/route.ts` - Added GET handler for polling
  - `src/hooks/useStatusPolling.ts` - New hook for polling with visibility API
  - `src/components/RunDetailClient.tsx` - Integrated polling hook, added refreshing indicator
  - `src/components/LanesManager.tsx` - Converted to controlled component
- **Learnings for future iterations:**
  - The `LanesManager` component previously managed its own state - converted to controlled pattern to sync with polling
  - When updating lane states from polling, use the `updateLaneState` callback for optimistic updates
  - The visibility API (`document.visibilityState`) is used to pause/resume polling when tab visibility changes
  - MergeView refresh is triggered by tracking lane state changes and incrementing a key prop
---

## 2026-02-04 - US-102: Uncommitted changes detection
- Implemented uncommitted file detection and display on lane cards
- Files changed:
  - `src/app/api/runs/[slug]/lane-status/route.ts` - New API endpoint returning uncommitted file counts and lists per lane
  - `src/hooks/useStatusPolling.ts` - Extended polling to fetch both status and uncommitted data in parallel
  - `src/components/LanesManager.tsx` - Added `laneUncommitted` prop to pass uncommitted data to cards
  - `src/components/RunDetailClient.tsx` - Pass `laneUncommitted` from polling hook to LanesManager
  - `src/components/LaneStatusCard.tsx` - Added orange badge and popover for uncommitted files
- **Learnings for future iterations:**
  - Fetch multiple API endpoints in parallel using `Promise.all` for better performance in polling hooks
  - Git status parsing: use `git status --porcelain` for machine-readable output, status codes are first 2 chars
  - Popover pattern: use `useRef` for trigger element, `useEffect` with click-outside detection, absolute positioning
  - Type casting in TypeScript: when iterating Object.entries with unknown shapes, cast to specific type
  - Orange color in the design system: `#f97316` with `rgba(249, 115, 22, 0.15)` for background
---

## 2026-02-04 - US-103: New commits detection
- Implemented commit tracking since lane launch with green badge display
- Files changed:
  - `src/lib/plan-schema.ts` - Added `commitsAtLaunch` field to `LaneStatusEntry` interface
  - `src/app/api/runs/[slug]/launch/route.ts` - Track commit count at launch time and store in status.json
  - `src/app/api/runs/[slug]/lane-status/route.ts` - Return `commitsSinceLaunch`, `commitsAtLaunch`, `currentCommits`, and `branch` per lane
  - `src/hooks/useStatusPolling.ts` - Extended `LaneUncommittedStatus` interface with commits fields
  - `src/components/LaneStatusCard.tsx` - Added green "+X commits" badge with click handler for git log
  - `src/app/api/runs/[slug]/git-log/route.ts` - New API endpoint to open iTerm2/Terminal with git log
- **Learnings for future iterations:**
  - Use `git rev-list --count HEAD` to get commit count in a branch/worktree
  - Store baseline commit count at launch time in status.json to calculate "commits since launch"
  - Green color in the design system: `#22c55e` with `rgba(34, 197, 94, 0.15)` for background
  - AppleScript can be used to open terminal windows with specific commands via `osascript -e`
  - Check for iTerm2 at `/Applications/iTerm.app` before falling back to Terminal.app
---

## 2026-02-04 - US-104: Ready to complete? smart suggestions
- Implemented completion signal detection and suggestion banners on lane cards
- Files changed:
  - `src/lib/plan-schema.ts` - Added `suggestionDismissed` field to `LaneStatusEntry` interface
  - `src/app/api/runs/[slug]/lane-status/route.ts` - Added completion detection logic (REVIEW.md, FINDINGS.md, commit patterns)
  - `src/app/api/runs/[slug]/status/route.ts` - Added `suggestionDismissed` field handling in POST
  - `src/hooks/useStatusPolling.ts` - Added `CompletionSuggestion` interface and included in polling data
  - `src/components/LaneStatusCard.tsx` - Added suggestion banner with "Mark Complete" and dismiss buttons
- **Learnings for future iterations:**
  - Completion patterns to detect: REVIEW.md, FINDINGS.md, commit messages with "complete", "done", "finished", "ready for review"
  - Only show suggestions for lanes with `status === "in_progress"` to avoid suggesting on already complete/pending lanes
  - Store dismissal state in status.json per lane to persist across page reloads
  - Use regex patterns with `/i` flag for case-insensitive matching on commit messages
  - `git log --oneline -5 --format=%s` returns just the subject lines of recent commits
---

## 2026-02-04 - US-105: WebSocket layer for live updates
- Implemented Socket.io WebSocket server with polling fallback for real-time updates
- Files changed:
  - `src/lib/websocket/types.ts` - Event type definitions (ServerToClientEvents, ClientToServerEvents)
  - `src/lib/websocket/server.ts` - Socket.io server on port 3001 with event emission functions
  - `src/lib/websocket/init.ts` - Server initialization helper (auto-starts when imported)
  - `src/lib/websocket/index.ts` - Module exports
  - `src/hooks/useWebSocket.ts` - Client-side hook for WebSocket connection with auto-reconnect
  - `src/hooks/useRealtimeStatus.ts` - Combines WebSocket + polling with adaptive intervals
  - `src/components/ConnectionStatusIndicator.tsx` - Fixed footer indicator showing connection state
  - `src/components/RunDetailClient.tsx` - Switched from useStatusPolling to useRealtimeStatus
  - `src/app/api/runs/[slug]/status/route.ts` - Initializes WebSocket server, emits lane-status-change events
  - `package.json` - Added socket.io and socket.io-client dependencies
- **Learnings for future iterations:**
  - Socket.io server runs on separate port (3001) from Next.js app (3000) - configure CORS for both localhost variants
  - Use refs for event handlers in useWebSocket to avoid stale closures in socket event callbacks
  - WebSocket reconnect: handle manually (reconnection: false) to control backoff timing
  - Polling interval adapts: 30s when WebSocket connected, 5s when disconnected (fallback)
  - Initialize WebSocket server via side effect in API route module load (`initializeWebSocketServer()`)
  - ConnectionStatus type: "connecting" | "connected" | "disconnected" | "error"
  - Event types: lane-activity, lane-status-change, merge-ready, run-complete, connection-status
---

## 2026-02-04 - US-106: File watcher service
- Implemented FileWatcher class for real-time worktree monitoring
- Files changed:
  - `src/lib/file-watcher/file-watcher.ts` - FileWatcher class with debouncing and WebSocket integration
  - `src/lib/file-watcher/index.ts` - Module exports
  - `src/app/api/runs/[slug]/watcher/route.ts` - API endpoint to start/stop watcher
- **Learnings for future iterations:**
  - Node.js `fs.watch` with `recursive: true` monitors entire directory tree on macOS
  - Debouncing pattern: store pending events in a Map (keyed by path), reset timer on each new event
  - Ignore patterns for `.git/`, `node_modules/`, `.next/`, temp files to reduce noise
  - Singleton pattern for watchers: Map<runSlug, FileWatcher> ensures one watcher per run
  - Watch error recovery: on watcher error, close and restart after 1 second delay
  - File existence check after `rename` event determines if it was create vs delete
  - Worktrees stored in `~/.openclaw/workspace/warroom/worktrees/{runSlug}/{laneName}`
---

## 2026-02-04 - US-201: Launch All Ready Lanes button
- Implemented "Launch All Ready" button for batch lane launching
- Files changed:
  - `src/components/RunDetailClient.tsx` - Added Launch All Ready button, progress indicator, and summary display
- **Learnings for future iterations:**
  - Button displays count of ready lanes: "Launch All Ready (3)" for clear feedback
  - Sequential launching uses 2-second delays via `setTimeout` in async loop
  - Progress indicator shows "Launching X of Y..." during multi-lane launch
  - Summary shows launched count, blocked count, and failed count after completion
  - Ready lanes = pending/in_progress lanes where all dependencies are complete
  - Use `useRef` for abort flag to allow cancellation of sequential operations
  - Autonomy settings are respected per-lane by reading from `laneStates[laneId].autonomy`
---
